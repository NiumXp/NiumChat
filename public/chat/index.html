<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Node chat</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.1/socket.io.js"></script>

    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <p id="note">VocÃª pode digitar <strong class="command">/clear</strong> para limpar as mensagens.</p>
    <div id="squares" class="flex">
        <div class="square purple"></div>
        <div class="square crimson"></div>
        <div class="square wheat"></div>
        <div class="square green"></div>
        <div class="square blue"></div>
    </div>
    <div id="chat">
        <div class="messages"></div>
        <form id="text-box" class="flex">
            <input id="message" type="text" name="message" autocomplete="off" placeholder="Digite sua mensagem">
            <button type="submit">Enviar</button>
        </form>
    </div>

    <script type="text/javascript" defer>
        const address = "http://localhost:3000";
        // const address = 'https://nium-chat.herokuapp.com';
        const socket = io(address);

        const mentionRegExp = new RegExp(/\@([a-zA-Z0-9]+)/gm)

        const squares = document.getElementsByClassName('square');

        function getCookie(name) {
            const nameEQ = `${name}=`;
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        function getName() {
            return getCookie('chatUsername') || socket.id;
        }

        for (square of squares) square.addEventListener('click', onSquareClicked);

        function onSquareClicked(square) {
            let r = document.querySelector(':root');
            square = window.getComputedStyle(square.target);

            r.style.setProperty('--border', square.getPropertyValue('border-color'));
            r.style.setProperty('--background', square.getPropertyValue('background-color'));
        }

        function updateScroll() {
            $('.messages').animate({ scrollTop: $('.messages').prop('scrollHeight') }, 500);
        }

        function addMessageRendered(html) {
            $('.messages').append(html);
        }

        function renderUsername(name) {
            const today = new Date();
            const minutes = today.getMinutes();

            name = `${name} at ${today.getHours()}:${minutes <= 9? '0' + minutes : minutes}`;
            return "<h5 class='username'>" + name + "</h5>";
        }

        function renderMessageContent(string) {
            string = string.replace(mentionRegExp, (item) => {
                console.log(item);
                return `<span class='mention'>${item}</span>`
            })
            return `<p>${string}</p>`
        }

        function renderMessage(message) {
            addMessageRendered(
                "<div class='message'><img class='user-image' src='" + message.author.avatar_url + "'><div class='content'>" + 
                renderUsername(message.author.name) + 
                renderMessageContent(message.content) + "</div></div>"
            );

            updateScroll();
        }
        
        function playAudioNotification(path) {
            return new Audio(`./${path}.ogg`).play();
        }

        socket.on("messageNotSended", (m) => {});

        socket.on("receivedMessage", (m) => {
            renderMessage(m);
            console.log(m.mentions);

            if (m.mentions.includes(`@${getName()}`)) return playAudioNotification('mention');
            
            return playAudioNotification('message');
        })

        socket.on("messageSended", (m) => {
            document.getElementById("message").value = '';
            renderMessage(m);
        })

        $("#chat").submit((event) => {
            event.preventDefault();
            const message = $("input[name=message]").val();

            if (message.length) {
                if (message === "/clear") return $(".messages").html("");

                return socket.emit("sendMessage", {
                    author: {
                        name: getName(),
                        avatar_url: getCookie("chatAvatarUrl")
                    },
                    content: message
                });
            }
        })
    </script>
</body>
</html>
